<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Example Firestore Quiz - AI Learning Platform</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 0; }
.nav-header { background: #2d3748; padding: 15px 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.3); display: flex; justify-content: space-between; align-items: center; }
.nav-header a { color: #90cdf4; text-decoration: none; font-weight: 600; font-size: 1.1em; }
.nav-title { color: #fff; font-size: 1.2em; font-weight: 700; }
.container { max-width: 900px; margin: 20px auto; background: #fff; border-radius: 15px; padding: 40px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }

/* Login Notice Styles */
.login-notice { background: #fff3cd; border: 2px solid #ffc107; border-radius: 10px; padding: 20px; margin-bottom: 25px; display: flex; align-items: center; gap: 15px; }
.login-notice.logged-in { background: #d4edda; border-color: #28a745; }
.login-notice-icon { font-size: 2em; }
.login-notice-content { flex: 1; }
.login-notice-title { font-weight: 700; font-size: 1.1em; margin-bottom: 5px; color: #856404; }
.login-notice.logged-in .login-notice-title { color: #155724; }
.login-notice-text { color: #856404; font-size: 0.95em; }
.login-notice.logged-in .login-notice-text { color: #155724; }
.login-notice a { color: #0066cc; text-decoration: underline; font-weight: 600; }

h1 { text-align: center; color: #2d3748; font-size: 2.5em; margin-bottom: 15px; }
.subtitle { text-align: center; color: #666; margin-bottom: 30px; font-size: 1.1em; }
.info-box { background: #e3f2fd; border-left: 4px solid #2196F3; padding: 15px; border-radius: 5px; margin-bottom: 25px; }
.info-box strong { color: #1976d2; }

.question-card { background: #f8f9fa; padding: 25px; border-radius: 10px; margin: 20px 0; border-left: 4px solid #667eea; }
.question-card.answered-correct { border-left-color: #4CAF50; background: #f1f8f4; }
.question-card.answered-wrong { border-left-color: #f44336; background: #ffebee; }
.question-number { color: #667eea; font-weight: 600; margin-bottom: 10px; }
.question-text { font-size: 1.2em; color: #2d3748; margin-bottom: 20px; line-height: 1.6; }
.options { display: flex; flex-direction: column; gap: 12px; }
.option { background: #fff; padding: 15px 20px; border-radius: 8px; border: 2px solid #e0e0e0; cursor: pointer; transition: all 0.3s; }
.option:hover { border-color: #667eea; transform: translateX(5px); }
.option.selected { border-color: #667eea; background: #e3f2fd; }
.option.correct { border-color: #4CAF50; background: #c8e6c9; }
.option.wrong { border-color: #f44336; background: #ffcdd2; }
.option.disabled { cursor: not-allowed; opacity: 0.7; }
.explanation { margin-top: 15px; padding: 15px; background: #fff9c4; border-radius: 6px; border-left: 3px solid #fbc02d; display: none; }
.explanation.show { display: block; }
.explanation strong { color: #f57c00; }
.progress-bar { background: #e0e0e0; height: 10px; border-radius: 5px; margin: 20px 0; overflow: hidden; }
.progress-fill { background: linear-gradient(90deg, #667eea, #764ba2); height: 100%; transition: width 0.3s; }
.quiz-actions { display: flex; gap: 15px; justify-content: center; margin: 30px 0; flex-wrap: wrap; }
button { padding: 15px 30px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 1.05em; transition: all 0.3s; }
.btn-primary { background: #4CAF50; color: #fff; }
.btn-primary:hover { background: #45a049; transform: scale(1.05); }
.btn-primary:disabled { background: #ccc; cursor: not-allowed; transform: none; }
.btn-secondary { background: #2196F3; color: #fff; }
.btn-secondary:hover { background: #1976d2; }
.btn-dashboard { background: #764ba2; color: #fff; }
.btn-dashboard:hover { background: #5a3780; }

.results-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; padding: 40px; border-radius: 15px; text-align: center; margin: 30px 0; }
.results-card h2 { font-size: 2.5em; margin-bottom: 20px; }
.score-display { font-size: 4em; font-weight: bold; margin: 20px 0; }
.results-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px; margin: 30px 0; }
.result-stat { background: rgba(255,255,255,0.2); padding: 20px; border-radius: 10px; }
.result-stat-value { font-size: 2em; font-weight: bold; }
.result-stat-label { margin-top: 8px; opacity: 0.9; }

/* Loading and Success Message Styles */
.save-status { margin-top: 20px; padding: 15px; border-radius: 8px; text-align: center; font-weight: 600; }
.save-status.loading { background: #e3f2fd; color: #1976d2; }
.save-status.success { background: #d4edda; color: #155724; }
.save-status.error { background: #f8d7da; color: #721c24; }
.spinner { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(25, 118, 210, 0.3); border-top-color: #1976d2; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 10px; }
@keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>
<body>
<nav class="nav-header">
    <div class="nav-title">Example Firestore Quiz Integration</div>
    <div>
        <a href="../index.html">‚Üê Back to Quizzes</a>
    </div>
</nav>
<div class="container">
    <!-- ============================================================
         LOGIN STATUS NOTICE
         Shows whether user is logged in and can save their score
         ============================================================ -->
    <div id="loginNotice" class="login-notice">
        <div class="login-notice-icon">‚è≥</div>
        <div class="login-notice-content">
            <div class="login-notice-title">Checking login status...</div>
            <div class="login-notice-text">Please wait...</div>
        </div>
    </div>

    <h1>Example: Firestore Quiz Integration</h1>
    <p class="subtitle">Demonstrates how to save quiz scores to Firebase Firestore</p>

    <div class="info-box">
        <strong>üìù Note for Developers:</strong> This quiz demonstrates Firestore integration.
        When logged in, your score will be saved to Firebase Firestore with tracking for
        score, time spent, and attempt history. Check the source code for implementation details!
    </div>

    <div class="progress-bar">
        <div class="progress-fill" id="progressBar" style="width: 0%"></div>
    </div>

    <div id="quizContent"></div>

    <div class="quiz-actions" id="quizActions">
        <button class="btn-primary" id="submitBtn" onclick="submitQuiz()" disabled>Submit Quiz</button>
        <button class="btn-secondary" onclick="retakeQuiz()">Retake Quiz</button>
    </div>

    <!-- Save status message area -->
    <div id="saveStatus"></div>
</div>

<!-- ============================================================
     FIRESTORE INTEGRATION - MODULE SCRIPT
     Import Firebase utilities as ES6 modules
     ============================================================ -->
<script type="module">
// ============================================================
// IMPORT FIREBASE UTILITIES
// These functions handle authentication and Firestore operations
// ============================================================
import { saveQuizScore, getCurrentUser } from '../../auth/auth-utils.js';

// ============================================================
// QUIZ DATA
// 5 sample questions about AI/ML concepts
// ============================================================
const quizData = {
    // IMPORTANT: This ID must match what you pass to saveQuizScore()
    id: 'example-firestore-quiz',
    questions: [
        {
            question: "What is Machine Learning?",
            options: [
                "A type of physical exercise for computers",
                "The ability of computers to learn from data without explicit programming",
                "A way to clean data",
                "A programming language"
            ],
            correct: 1,
            explanation: "Machine Learning is a subset of AI where computers learn patterns from data and improve their performance without being explicitly programmed for each task."
        },
        {
            question: "Which of these is a supervised learning task?",
            options: [
                "Clustering customers into groups",
                "Predicting house prices based on features",
                "Finding patterns in unlabeled data",
                "Dimensionality reduction"
            ],
            correct: 1,
            explanation: "Predicting house prices is supervised learning because you have labeled training data (house features with their known prices) to learn from."
        },
        {
            question: "What is the purpose of a training dataset?",
            options: [
                "To test the final model",
                "To teach the model patterns and relationships",
                "To validate hyperparameters",
                "To deploy the model"
            ],
            correct: 1,
            explanation: "The training dataset is used to teach the model by showing it examples with known answers, allowing it to learn patterns and relationships."
        },
        {
            question: "What does 'overfitting' mean?",
            options: [
                "The model is too large",
                "The model memorizes training data but performs poorly on new data",
                "The model is too simple",
                "The model trains too quickly"
            ],
            correct: 1,
            explanation: "Overfitting occurs when a model learns the training data too well, including noise and outliers, causing it to perform poorly on new, unseen data."
        },
        {
            question: "What is a neural network activation function?",
            options: [
                "A function that starts the network",
                "A function that introduces non-linearity to enable learning complex patterns",
                "A function that saves the network",
                "A function that counts neurons"
            ],
            correct: 1,
            explanation: "Activation functions introduce non-linearity into neural networks, allowing them to learn complex, non-linear relationships in data. Without them, the network would only learn linear patterns."
        }
    ]
};

// ============================================================
// QUIZ STATE VARIABLES
// ============================================================
let userAnswers = [];
let submitted = false;
let currentUser = null;
let quizStartTime = null; // Track when quiz started
let quizEndTime = null;   // Track when quiz ended

// ============================================================
// INITIALIZE QUIZ
// Called when page loads
// ============================================================
async function init() {
    // Start timing the quiz
    quizStartTime = new Date();

    // Check authentication status
    await checkAuthStatus();

    // Load quiz questions
    loadQuiz();
    loadProgress();
}

// ============================================================
// CHECK AUTHENTICATION STATUS
// Shows login notice and determines if scores can be saved
// ============================================================
async function checkAuthStatus() {
    try {
        // FIREBASE INTEGRATION POINT #1
        // Get the currently logged-in user (or null if not logged in)
        currentUser = await getCurrentUser();

        const noticeEl = document.getElementById('loginNotice');

        if (currentUser) {
            // User is logged in - show success notice
            noticeEl.className = 'login-notice logged-in';
            noticeEl.innerHTML = `
                <div class="login-notice-icon">‚úì</div>
                <div class="login-notice-content">
                    <div class="login-notice-title">Logged in as ${currentUser.displayName || currentUser.email}</div>
                    <div class="login-notice-text">Your quiz score will be saved to your dashboard!</div>
                </div>
            `;
        } else {
            // User is NOT logged in - show warning
            noticeEl.className = 'login-notice';
            noticeEl.innerHTML = `
                <div class="login-notice-icon">‚ö†Ô∏è</div>
                <div class="login-notice-content">
                    <div class="login-notice-title">Not Logged In</div>
                    <div class="login-notice-text">
                        <a href="../../auth/login.html">Log in</a> to save your score to your dashboard and track your progress!
                    </div>
                </div>
            `;
        }
    } catch (error) {
        console.error('Error checking auth status:', error);
    }
}

// ============================================================
// LOAD QUIZ QUESTIONS
// Renders all questions to the page
// ============================================================
function loadQuiz() {
    const content = document.getElementById('quizContent');
    content.innerHTML = quizData.questions.map((q, index) => `
        <div class="question-card" id="question${index}">
            <div class="question-number">Question ${index + 1} of ${quizData.questions.length}</div>
            <div class="question-text">${q.question}</div>
            <div class="options">
                ${q.options.map((option, optIndex) => `
                    <div class="option" onclick="window.selectOption(${index}, ${optIndex})" id="q${index}_opt${optIndex}">
                        ${option}
                    </div>
                `).join('')}
            </div>
            <div class="explanation" id="explanation${index}">
                <strong>Explanation:</strong> ${q.explanation}
            </div>
        </div>
    `).join('');
}

// ============================================================
// SELECT OPTION
// Called when user clicks on an answer option
// ============================================================
window.selectOption = function(questionIndex, optionIndex) {
    if (submitted) return;

    // Clear previous selection
    for (let i = 0; i < quizData.questions[questionIndex].options.length; i++) {
        document.getElementById(`q${questionIndex}_opt${i}`).classList.remove('selected');
    }

    // Mark new selection
    document.getElementById(`q${questionIndex}_opt${optionIndex}`).classList.add('selected');
    userAnswers[questionIndex] = optionIndex;

    updateProgress();
    checkSubmitEnabled();
}

// ============================================================
// CHECK IF ALL QUESTIONS ANSWERED
// Enables submit button when all questions have answers
// ============================================================
function checkSubmitEnabled() {
    const allAnswered = userAnswers.length === quizData.questions.length &&
                       userAnswers.every(a => a !== undefined);
    document.getElementById('submitBtn').disabled = !allAnswered;
}

// ============================================================
// UPDATE PROGRESS BAR
// Shows visual progress of quiz completion
// ============================================================
function updateProgress() {
    const progress = (userAnswers.filter(a => a !== undefined).length / quizData.questions.length) * 100;
    document.getElementById('progressBar').style.width = progress + '%';
}

// ============================================================
// SUBMIT QUIZ
// Grades the quiz and saves to Firestore if logged in
// ============================================================
window.submitQuiz = async function() {
    if (submitted) return;
    submitted = true;
    quizEndTime = new Date(); // Record end time

    let correct = 0;
    const answersArray = []; // Store detailed answers for Firestore

    // Grade each question
    quizData.questions.forEach((q, index) => {
        const questionCard = document.getElementById(`question${index}`);
        const userAnswer = userAnswers[index];
        const isCorrect = userAnswer === q.correct;

        if (isCorrect) {
            correct++;
            questionCard.classList.add('answered-correct');
        } else {
            questionCard.classList.add('answered-wrong');
        }

        // Record answer for Firestore (OPTIONAL but recommended)
        answersArray.push({
            questionIndex: index,
            userAnswer: userAnswer,
            correctAnswer: q.correct,
            isCorrect: isCorrect
        });

        // Show correct/wrong on options
        q.options.forEach((_, optIndex) => {
            const optEl = document.getElementById(`q${index}_opt${optIndex}`);
            optEl.classList.add('disabled');

            if (optIndex === q.correct) {
                optEl.classList.add('correct');
            } else if (optIndex === userAnswer && !isCorrect) {
                optEl.classList.add('wrong');
            }
        });

        // Show explanation
        document.getElementById(`explanation${index}`).classList.add('show');
    });

    const percentage = Math.round((correct / quizData.questions.length) * 100);

    // Calculate time spent in seconds
    const timeSpentSeconds = Math.round((quizEndTime - quizStartTime) / 1000);

    // Show results on page
    showResults(correct, percentage, timeSpentSeconds);

    // ============================================================
    // FIRESTORE INTEGRATION POINT #2
    // Save score to Firestore if user is logged in
    // ============================================================
    await saveScoreToFirestore(correct, quizData.questions.length, percentage, timeSpentSeconds, answersArray);
}

// ============================================================
// SAVE SCORE TO FIRESTORE
// This is the main Firestore integration function
// ============================================================
async function saveScoreToFirestore(score, totalQuestions, percentage, timeSpent, answers) {
    const saveStatusEl = document.getElementById('saveStatus');

    // Check if user is logged in
    if (!currentUser) {
        saveStatusEl.className = 'save-status error';
        saveStatusEl.innerHTML = `
            ‚ö†Ô∏è Score not saved - You must be logged in to save scores.
            <a href="../../auth/login.html">Log in here</a>
        `;
        return;
    }

    // Show loading state
    saveStatusEl.className = 'save-status loading';
    saveStatusEl.innerHTML = `
        <div class="spinner"></div>
        Saving your score to Firestore...
    `;

    try {
        // ============================================================
        // CALL FIRESTORE SAVE FUNCTION
        // Prepare the score data object with all required fields
        // ============================================================
        const scoreData = {
            score: score,                    // Number of correct answers
            totalQuestions: totalQuestions,  // Total number of questions
            timeSpent: timeSpent,            // Time in seconds
            answers: answers                 // Optional: detailed answer array
            // percentage will be calculated automatically by saveQuizScore
        };

        // Call the Firebase utility function
        // quizId MUST match the quiz identifier
        const result = await saveQuizScore(quizData.id, scoreData);

        if (result.success) {
            // Success! Show success message
            saveStatusEl.className = 'save-status success';
            saveStatusEl.innerHTML = `
                ‚úì Score saved successfully!
                ${result.scoreRecord.attempts > 1 ? `(Attempt ${result.scoreRecord.attempts})` : ''}
            `;

            // Add "View Dashboard" button to quiz actions
            const dashboardBtn = document.createElement('button');
            dashboardBtn.className = 'btn-dashboard';
            dashboardBtn.textContent = 'üìä View Dashboard';
            dashboardBtn.onclick = () => window.location.href = '../../auth/dashboard.html';
            document.getElementById('quizActions').appendChild(dashboardBtn);

        } else {
            // Error saving
            saveStatusEl.className = 'save-status error';
            saveStatusEl.innerHTML = `
                ‚úó Error saving score: ${result.error}
            `;
        }
    } catch (error) {
        console.error('Error saving to Firestore:', error);
        saveStatusEl.className = 'save-status error';
        saveStatusEl.innerHTML = `
            ‚úó Unexpected error: ${error.message}
        `;
    }
}

// ============================================================
// SHOW RESULTS
// Displays the quiz results card
// ============================================================
function showResults(correct, percentage, timeSpent) {
    const content = document.getElementById('quizContent');
    let message = '';
    if (percentage >= 90) message = 'Excellent! You have mastered this topic!';
    else if (percentage >= 70) message = 'Great job! You understand the key concepts!';
    else if (percentage >= 50) message = 'Good effort! Review the material to improve!';
    else message = 'Keep learning! Review the material and try again!';

    // Format time spent
    const minutes = Math.floor(timeSpent / 60);
    const seconds = timeSpent % 60;
    const timeDisplay = minutes > 0 ? `${minutes}m ${seconds}s` : `${seconds}s`;

    content.innerHTML = `
        <div class="results-card">
            <h2>Quiz Complete!</h2>
            <div class="score-display">${percentage}%</div>
            <p style="font-size: 1.3em; margin: 20px 0;">${message}</p>
            <div class="results-grid">
                <div class="result-stat">
                    <div class="result-stat-value">${correct}</div>
                    <div class="result-stat-label">Correct</div>
                </div>
                <div class="result-stat">
                    <div class="result-stat-value">${quizData.questions.length - correct}</div>
                    <div class="result-stat-label">Incorrect</div>
                </div>
                <div class="result-stat">
                    <div class="result-stat-value">${timeDisplay}</div>
                    <div class="result-stat-label">Time Spent</div>
                </div>
            </div>
        </div>
    ` + content.innerHTML;

    document.getElementById('submitBtn').style.display = 'none';
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

// ============================================================
// RETAKE QUIZ
// Resets the quiz to initial state
// ============================================================
window.retakeQuiz = function() {
    if (confirm('Retake the quiz? This will start a new attempt.')) {
        userAnswers = [];
        submitted = false;
        quizStartTime = new Date(); // Reset timer
        quizEndTime = null;
        document.getElementById('submitBtn').style.display = 'inline-block';
        document.getElementById('saveStatus').innerHTML = '';

        // Remove dashboard button if it exists
        const dashboardBtn = document.querySelector('.btn-dashboard');
        if (dashboardBtn) dashboardBtn.remove();

        init();
        updateProgress();
    }
}

function loadProgress() {
    // Could load previous answers here if needed
}

// ============================================================
// START THE QUIZ
// ============================================================
init();
</script>

<!-- ============================================================
     INTEGRATION NOTES FOR DEVELOPERS
     ============================================================

     To integrate Firestore into YOUR quiz, follow these steps:

     1. ADD MODULE SCRIPT TYPE
        Change <script> to <script type="module">

     2. IMPORT FIREBASE UTILITIES
        import { saveQuizScore, getCurrentUser } from '../../auth/auth-utils.js';

     3. ADD QUIZ START TIME TRACKING
        let quizStartTime = new Date();

     4. CHECK AUTH STATUS (OPTIONAL BUT RECOMMENDED)
        currentUser = await getCurrentUser();
        // Show login notice if not logged in

     5. CALCULATE TIME SPENT
        const timeSpentSeconds = Math.round((new Date() - quizStartTime) / 1000);

     6. PREPARE SCORE DATA
        const scoreData = {
            score: correctAnswers,
            totalQuestions: totalQuestions,
            timeSpent: timeSpentSeconds,
            answers: answersArray  // Optional but recommended
        };

     7. CALL SAVE FUNCTION
        const result = await saveQuizScore('your-quiz-id', scoreData);

     8. HANDLE RESULT
        if (result.success) {
            // Show success message
            // Add dashboard link
        } else {
            // Show error message
        }

     That's it! Your quiz now saves scores to Firestore.

     ============================================================ -->
</body>
</html>
