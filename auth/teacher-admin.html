<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Admin Panel - AI Learning Platform</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .dashboard-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .dashboard-header h1 {
            font-size: 2em;
            margin-bottom: 5px;
        }

        .dashboard-header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .header-actions {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
            font-size: 0.95em;
        }

        .btn-secondary {
            background: white;
            color: #667eea;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 255, 255, 0.3);
        }

        .btn-primary {
            background: #48bb78;
            color: white;
        }

        .btn-primary:hover {
            background: #38a169;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .btn-danger:hover {
            background: #da190b;
        }

        .dashboard-content {
            padding: 40px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 20px;
        }

        .section-title {
            font-size: 1.8em;
            color: #2d3748;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .stat-card h3 {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: 700;
        }

        .controls-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
            align-items: center;
        }

        .search-box {
            flex: 1;
            min-width: 250px;
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 12px 40px 12px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.95em;
            transition: border-color 0.3s;
        }

        .search-box input:focus {
            outline: none;
            border-color: #667eea;
        }

        .search-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #718096;
            font-size: 1.2em;
        }

        .sort-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .sort-controls label {
            font-weight: 600;
            color: #2d3748;
        }

        .sort-controls select {
            padding: 10px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.95em;
            cursor: pointer;
            background: white;
            transition: border-color 0.3s;
        }

        .sort-controls select:focus {
            outline: none;
            border-color: #667eea;
        }

        .students-table-container {
            overflow-x: auto;
            border-radius: 12px;
            border: 2px solid #e2e8f0;
        }

        .students-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        .students-table thead {
            background: #f8f9fa;
            border-bottom: 2px solid #e2e8f0;
        }

        .students-table th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #2d3748;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .students-table tbody tr {
            border-bottom: 1px solid #e2e8f0;
            cursor: pointer;
            transition: background 0.2s;
        }

        .students-table tbody tr:hover {
            background: #f8f9fa;
        }

        .students-table tbody tr.expanded {
            background: #f0f4ff;
        }

        .students-table td {
            padding: 15px;
            color: #4a5568;
        }

        .student-name {
            font-weight: 600;
            color: #2d3748;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .expand-icon {
            color: #667eea;
            font-size: 1.2em;
            transition: transform 0.3s;
        }

        .expanded .expand-icon {
            transform: rotate(90deg);
        }

        .score-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9em;
        }

        .score-excellent {
            background: #c6f6d5;
            color: #22543d;
        }

        .score-good {
            background: #bee3f8;
            color: #2c5282;
        }

        .score-fair {
            background: #feebc8;
            color: #7c2d12;
        }

        .score-poor {
            background: #fed7d7;
            color: #742a2a;
        }

        .quiz-details-row {
            display: none;
        }

        .quiz-details-row.show {
            display: table-row;
        }

        .quiz-details-cell {
            padding: 0 !important;
            background: #f8f9fa;
        }

        .quiz-details-content {
            padding: 25px 40px;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .quiz-details-header {
            font-size: 1.1em;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e2e8f0;
        }

        .quiz-scores-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
        }

        .quiz-score-card {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 15px;
        }

        .quiz-score-card h4 {
            color: #2d3748;
            margin-bottom: 10px;
            font-size: 1em;
        }

        .quiz-score-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            font-size: 0.9em;
        }

        .quiz-score-details div {
            display: flex;
            flex-direction: column;
        }

        .quiz-score-details label {
            color: #718096;
            font-size: 0.85em;
            margin-bottom: 3px;
        }

        .quiz-score-details span {
            color: #2d3748;
            font-weight: 600;
        }

        .no-quizzes {
            text-align: center;
            padding: 30px;
            color: #718096;
            font-style: italic;
        }

        .loading {
            text-align: center;
            padding: 60px 20px;
            color: #667eea;
        }

        .spinner {
            width: 50px;
            height: 50px;
            margin: 0 auto 20px;
            border: 5px solid #e2e8f0;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #718096;
        }

        .empty-state-icon {
            font-size: 5em;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 1.5em;
            margin-bottom: 10px;
            color: #2d3748;
        }

        .error-message {
            background: #fed7d7;
            color: #742a2a;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #f44336;
        }

        .error-message h3 {
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        @media (max-width: 768px) {
            .dashboard-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .dashboard-content {
                padding: 20px;
            }

            .controls-bar {
                flex-direction: column;
                align-items: stretch;
            }

            .search-box {
                min-width: 100%;
            }

            .sort-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .sort-controls select {
                width: 100%;
            }

            .students-table {
                font-size: 0.9em;
            }

            .students-table th,
            .students-table td {
                padding: 10px;
            }

            .quiz-details-content {
                padding: 20px;
            }

            .quiz-scores-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="dashboard-header">
            <div>
                <h1 id="teacherName">Teacher Admin Panel</h1>
                <p>Manage students and view quiz performance</p>
            </div>
            <div class="header-actions">
                <a href="../index.html" class="btn btn-secondary">Main Site</a>
                <a href="./dashboard.html" class="btn btn-secondary">My Dashboard</a>
                <button id="logoutBtn" class="btn btn-danger">Logout</button>
            </div>
        </div>

        <div class="dashboard-content">
            <div id="errorContainer"></div>

            <div id="loadingState" class="loading">
                <div class="spinner"></div>
                <p>Loading student data...</p>
            </div>

            <div id="mainContent" style="display: none;">
                <div class="section-header">
                    <h2 class="section-title">
                        <span>üë®‚Äçüéì</span>
                        <span>Student Performance Dashboard</span>
                    </h2>
                    <button id="exportBtn" class="btn btn-primary">
                        üìä Export to CSV
                    </button>
                </div>

                <div class="stats-row">
                    <div class="stat-card">
                        <h3>Total Students</h3>
                        <div class="stat-value" id="totalStudents">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Total Quizzes Taken</h3>
                        <div class="stat-value" id="totalQuizzes">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Average Class Score</h3>
                        <div class="stat-value" id="classAverage">0%</div>
                    </div>
                    <div class="stat-card">
                        <h3>Active Students</h3>
                        <div class="stat-value" id="activeStudents">0</div>
                    </div>
                </div>

                <div class="controls-bar">
                    <div class="search-box">
                        <input type="text" id="searchInput" placeholder="Search students by name or email...">
                        <span class="search-icon">üîç</span>
                    </div>
                    <div class="sort-controls">
                        <label for="sortSelect">Sort by:</label>
                        <select id="sortSelect">
                            <option value="name">Name (A-Z)</option>
                            <option value="name-desc">Name (Z-A)</option>
                            <option value="quizzes">Total Quizzes (High to Low)</option>
                            <option value="quizzes-asc">Total Quizzes (Low to High)</option>
                            <option value="average">Average Score (High to Low)</option>
                            <option value="average-asc">Average Score (Low to High)</option>
                        </select>
                    </div>
                </div>

                <div class="students-table-container">
                    <table class="students-table">
                        <thead>
                            <tr>
                                <th style="width: 40px;"></th>
                                <th>Student Name</th>
                                <th>Email</th>
                                <th style="text-align: center;">Total Quizzes</th>
                                <th style="text-align: center;">Average Score</th>
                            </tr>
                        </thead>
                        <tbody id="studentsTableBody">
                            <!-- Student rows will be inserted here -->
                        </tbody>
                    </table>
                </div>

                <div id="emptyState" class="empty-state" style="display: none;">
                    <div class="empty-state-icon">üë®‚Äçüéì</div>
                    <h3>No Students Found</h3>
                    <p>No students are currently registered in the system.</p>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { requireAuth, isTeacher, getAllStudentsData, exportToCSV, logout } from './auth-utils.js';

        let currentUser = null;
        let studentsData = [];
        let filteredStudentsData = [];

        // Initialize admin panel
        async function initAdminPanel() {
            try {
                // Require authentication
                currentUser = await requireAuth();
                if (!currentUser) return;

                // Check if user is teacher
                const teacherCheck = await isTeacher(currentUser.uid);
                if (!teacherCheck) {
                    showError('Unauthorized Access', 'You must be a teacher to access this page. Redirecting...');
                    setTimeout(() => {
                        window.location.href = './dashboard.html';
                    }, 2000);
                    return;
                }

                // Update teacher name
                document.getElementById('teacherName').textContent = `üëã ${currentUser.displayName || 'Teacher'}`;

                // Load students data
                await loadStudentsData();
            } catch (error) {
                showError('Initialization Error', error.message);
            }
        }

        async function loadStudentsData() {
            const loadingState = document.getElementById('loadingState');
            const mainContent = document.getElementById('mainContent');

            loadingState.style.display = 'block';
            mainContent.style.display = 'none';

            const result = await getAllStudentsData();

            if (result.success) {
                studentsData = result.students;
                filteredStudentsData = [...studentsData];

                if (studentsData.length === 0) {
                    loadingState.style.display = 'none';
                    document.getElementById('emptyState').style.display = 'block';
                } else {
                    updateStats();
                    sortAndDisplayStudents();
                    loadingState.style.display = 'none';
                    mainContent.style.display = 'block';
                }
            } else {
                showError('Error Loading Data', result.error);
                loadingState.style.display = 'none';
            }
        }

        function showError(title, message) {
            const errorContainer = document.getElementById('errorContainer');
            errorContainer.innerHTML = `
                <div class="error-message">
                    <h3>${title}</h3>
                    <p>${message}</p>
                </div>
            `;
        }

        function updateStats() {
            const totalStudents = studentsData.length;
            let totalQuizzes = 0;
            let totalScores = 0;
            let studentsWithQuizzes = 0;

            studentsData.forEach(student => {
                const quizCount = student.profile.totalQuizzesTaken || 0;
                totalQuizzes += quizCount;

                if (quizCount > 0) {
                    studentsWithQuizzes++;
                    totalScores += student.profile.averageScore || 0;
                }
            });

            const classAverage = studentsWithQuizzes > 0 ? Math.round(totalScores / studentsWithQuizzes) : 0;

            document.getElementById('totalStudents').textContent = totalStudents;
            document.getElementById('totalQuizzes').textContent = totalQuizzes;
            document.getElementById('classAverage').textContent = classAverage + '%';
            document.getElementById('activeStudents').textContent = studentsWithQuizzes;
        }

        function sortAndDisplayStudents() {
            const sortBy = document.getElementById('sortSelect').value;

            filteredStudentsData.sort((a, b) => {
                switch (sortBy) {
                    case 'name':
                        return (a.profile.displayName || '').localeCompare(b.profile.displayName || '');
                    case 'name-desc':
                        return (b.profile.displayName || '').localeCompare(a.profile.displayName || '');
                    case 'quizzes':
                        return (b.profile.totalQuizzesTaken || 0) - (a.profile.totalQuizzesTaken || 0);
                    case 'quizzes-asc':
                        return (a.profile.totalQuizzesTaken || 0) - (b.profile.totalQuizzesTaken || 0);
                    case 'average':
                        return (b.profile.averageScore || 0) - (a.profile.averageScore || 0);
                    case 'average-asc':
                        return (a.profile.averageScore || 0) - (b.profile.averageScore || 0);
                    default:
                        return 0;
                }
            });

            displayStudents();
        }

        function displayStudents() {
            const tbody = document.getElementById('studentsTableBody');
            tbody.innerHTML = '';

            if (filteredStudentsData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="no-quizzes">No students match your search criteria.</td>
                    </tr>
                `;
                return;
            }

            filteredStudentsData.forEach((student, index) => {
                const name = student.profile.displayName || 'Unknown';
                const email = student.profile.email;
                const totalQuizzes = student.profile.totalQuizzesTaken || 0;
                const avgScore = student.profile.averageScore || 0;

                // Determine score badge class
                let scoreClass = 'score-poor';
                if (avgScore >= 90) scoreClass = 'score-excellent';
                else if (avgScore >= 75) scoreClass = 'score-good';
                else if (avgScore >= 60) scoreClass = 'score-fair';

                // Create main student row
                const row = document.createElement('tr');
                row.dataset.studentIndex = index;
                row.innerHTML = `
                    <td><span class="expand-icon">‚ñ∂</span></td>
                    <td>
                        <div class="student-name">${name}</div>
                    </td>
                    <td>${email}</td>
                    <td style="text-align: center;">${totalQuizzes}</td>
                    <td style="text-align: center;">
                        <span class="score-badge ${scoreClass}">${avgScore}%</span>
                    </td>
                `;

                row.addEventListener('click', () => toggleQuizDetails(row, student));
                tbody.appendChild(row);

                // Create quiz details row (hidden by default)
                const detailsRow = document.createElement('tr');
                detailsRow.className = 'quiz-details-row';
                detailsRow.dataset.studentIndex = index;
                detailsRow.innerHTML = `
                    <td colspan="5" class="quiz-details-cell">
                        <div class="quiz-details-content">
                            ${generateQuizDetailsHTML(student)}
                        </div>
                    </td>
                `;
                tbody.appendChild(detailsRow);
            });
        }

        function generateQuizDetailsHTML(student) {
            if (student.quizScores.length === 0) {
                return '<div class="no-quizzes">This student has not taken any quizzes yet.</div>';
            }

            const quizCardsHTML = student.quizScores
                .sort((a, b) => {
                    const dateA = a.completedAt?.toDate() || new Date(0);
                    const dateB = b.completedAt?.toDate() || new Date(0);
                    return dateB - dateA;
                })
                .map(quiz => {
                    const quizName = formatQuizTitle(quiz.quizId);
                    const completedDate = quiz.completedAt ?
                        quiz.completedAt.toDate().toLocaleDateString('en-US', {
                            year: 'numeric',
                            month: 'short',
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        }) : 'N/A';

                    return `
                        <div class="quiz-score-card">
                            <h4>${quizName}</h4>
                            <div class="quiz-score-details">
                                <div>
                                    <label>Score</label>
                                    <span>${quiz.score} / ${quiz.totalQuestions}</span>
                                </div>
                                <div>
                                    <label>Percentage</label>
                                    <span>${quiz.percentage}%</span>
                                </div>
                                <div>
                                    <label>Attempts</label>
                                    <span>${quiz.attempts || 1}</span>
                                </div>
                                <div>
                                    <label>Best Score</label>
                                    <span>${quiz.bestScore || quiz.score} / ${quiz.totalQuestions}</span>
                                </div>
                                <div style="grid-column: 1 / -1;">
                                    <label>Last Completed</label>
                                    <span>${completedDate}</span>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

            return `
                <div class="quiz-details-header">
                    üìä Quiz Performance (${student.quizScores.length} quiz${student.quizScores.length > 1 ? 'es' : ''})
                </div>
                <div class="quiz-scores-grid">
                    ${quizCardsHTML}
                </div>
            `;
        }

        function formatQuizTitle(quizId) {
            const titleMap = {
                'feedforward-nn': 'Feedforward Neural Networks',
                'rnn': 'Recurrent Neural Networks (RNN)',
                'cnn': 'Convolutional Neural Networks (CNN)',
                'lstm': 'Long Short-Term Memory (LSTM)',
                'gan': 'Generative Adversarial Networks (GAN)',
                'autoencoders': 'Autoencoders',
                'transformers': 'Transformer Networks'
            };

            return titleMap[quizId] || quizId.split('-').map(word =>
                word.charAt(0).toUpperCase() + word.slice(1)
            ).join(' ');
        }

        function toggleQuizDetails(row, student) {
            const index = row.dataset.studentIndex;
            const detailsRow = document.querySelector(`.quiz-details-row[data-student-index="${index}"]`);

            if (row.classList.contains('expanded')) {
                row.classList.remove('expanded');
                detailsRow.classList.remove('show');
            } else {
                // Close all other expanded rows
                document.querySelectorAll('.students-table tbody tr.expanded').forEach(tr => {
                    tr.classList.remove('expanded');
                });
                document.querySelectorAll('.quiz-details-row.show').forEach(tr => {
                    tr.classList.remove('show');
                });

                // Expand this row
                row.classList.add('expanded');
                detailsRow.classList.add('show');
            }
        }

        // Search functionality
        document.getElementById('searchInput').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();

            filteredStudentsData = studentsData.filter(student => {
                const name = (student.profile.displayName || '').toLowerCase();
                const email = (student.profile.email || '').toLowerCase();
                return name.includes(searchTerm) || email.includes(searchTerm);
            });

            sortAndDisplayStudents();
        });

        // Sort functionality
        document.getElementById('sortSelect').addEventListener('change', () => {
            sortAndDisplayStudents();
        });

        // Export to CSV
        document.getElementById('exportBtn').addEventListener('click', () => {
            if (studentsData.length === 0) {
                alert('No student data to export.');
                return;
            }

            exportToCSV(studentsData);
        });

        // Logout handler
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            const result = await logout();
            if (result.success) {
                window.location.href = '../index.html';
            }
        });

        // Initialize on page load
        initAdminPanel();
    </script>
</body>
</html>
