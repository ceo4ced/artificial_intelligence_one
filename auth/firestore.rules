rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================
    // HELPER FUNCTIONS
    // ============================================

    function isCurrentUser(userId) {
      return request.auth.uid == userId;
    }

    function hasRole(role) {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == role;
    }

    function isTeacher() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'teacher';
    }

    function isStudent() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'student';
    }

    // Refactored to remove 'let' statements for better compatibility
    function calculateAge(birthdate) {
      return int((request.time - timestamp(birthdate)) / duration.value('31536000s'));
    }

    function isAtLeast13(birthdate) {
      return calculateAge(birthdate) >= 13;
    }

    function isApprovedTeacherEmail(email) {
      return email in [
        'teacher@school.edu',
        'instructor@school.edu',
        'admin@school.edu'
      ];
    }

    // REFACTORED: Single expression, no IF statements
    function isValidRoleAssignment(newRole, email) {
      return newRole == 'student'
          || (newRole == 'teacher' && isApprovedTeacherEmail(email));
    }

    function roleNotChanged() {
      let currentUserDoc = get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
      return request.resource.data.role == currentUserDoc.role;
    }

    function hasRequiredUserFields() {
      return request.resource.data.keys().hasAll(['email', 'name', 'birthdate', 'role', 'createdAt']);
    }

    // ============================================
    // USER PROFILES COLLECTION RULES
    // ============================================

    match /users/{userId} {
      allow read: if isCurrentUser(userId) || isTeacher();

      allow create: if isCurrentUser(userId)
        && hasRequiredUserFields()
        && isAtLeast13(request.resource.data.birthdate)
        && isValidRoleAssignment(request.resource.data.role, request.resource.data.email)
        && request.resource.data.keys().hasOnly([
             'email', 'name', 'birthdate', 'role', 'createdAt',
             'bio', 'profilePictureUrl', 'school', 'grade'
           ]);

      allow update: if isCurrentUser(userId)
        && roleNotChanged()
        && request.resource.data.createdAt == resource.data.createdAt
        && request.resource.data.birthdate == resource.data.birthdate
        && request.resource.data.keys().hasOnly([
             'email', 'name', 'birthdate', 'role', 'createdAt',
             'bio', 'profilePictureUrl', 'school', 'grade',
             'lastUpdated'
           ]);

      allow delete: if false;

      // ============================================
      // QUIZ SCORES SUBCOLLECTION RULES
      // ============================================

      match /quizScores/{quizId} {
        allow read: if isCurrentUser(userId) || isTeacher();

        allow create: if isCurrentUser(userId)
          && request.resource.data.keys().hasAll(['quizId', 'score', 'maxScore', 'completedAt'])
          && request.resource.data.score >= 0
          && request.resource.data.score <= request.resource.data.maxScore
          && request.resource.data.keys().hasOnly([
               'quizId', 'score', 'maxScore', 'completedAt', 'answers',
               'timeTaken', 'feedback', 'attempts'
             ]);

        allow update: if isCurrentUser(userId)
          && isStudent()
          && request.resource.data.quizId == resource.data.quizId
          && request.resource.data.completedAt == resource.data.completedAt
          && request.resource.data.keys().hasOnly([
               'quizId', 'score', 'maxScore', 'completedAt', 'answers',
               'timeTaken', 'feedback', 'attempts', 'lastAttemptAt'
             ]);

        allow delete: if false;
      }
    }

    // ============================================
    // QUIZ DEFINITIONS COLLECTION (READ-ONLY)
    // ============================================

    match /quizzes/{quizId} {
      allow read: if request.auth != null;
      allow write: if false;
    }

    // ============================================
    // SYSTEM LOGS COLLECTION (AUDIT TRAIL)
    // ============================================

    match /systemLogs/{logId} {
      allow read: if isTeacher();
      allow write: if false;
    }

    // ============================================
    // CATCH-ALL
    // ============================================

    match /{document=**} {
      allow read, write: if false;
    }
  }
}
